#!/bin/sh
#
# S20-htpasswd - Create initial web users for lighttpd if missing
#
# Provides:          htpasswd-init
# Required-Start:    $local_fs
# Required-Stop:
# Default-Start:     S
# Default-Stop:
# Short-Description: Initialize webusers.htpasswd on first boot
#

HTPASSWD_FILE="/overlays/beaglebone/rootfs-overlay/etc/lighttpd/webusers.htpasswd"
HTPASSWD_DIR="$(dirname "$HTPASSWD_FILE")"

# Initial credentials (you will change them later!)
USER1_NAME="maintainer"
USER1_PASS="maintainer"
USER2_NAME="homer"
USER2_PASS="homer"

LIGHTTPD_SERVICE="lighttpd"   # adjust if your service name differs

# Return 0 if the command exists
have_cmd() { command -v "$1" >/dev/null 2>&1; }

# Generate a htpasswd line "user:hash"
# Prefers bcrypt via htpasswd, falls back to APR-MD5 via openssl.
gen_htpasswd_line() {
    _user="$1"
    _pass="$2"

    if have_cmd htpasswd; then
        # bcrypt (-B) with non-interactive (-b), no file (-n)
        htpasswd -nbB "$_user" "$_pass" 2>/dev/null && return 0
    fi

    if have_cmd openssl; then
        # APR-MD5 (Apache md5, a.k.a. $apr1$)
        _hash="$(openssl passwd -apr1 "$_pass" 2>/dev/null)" || return 1
        printf '%s:%s\n' "$_user" "$_hash"
        return 0
    fi

    return 1
}

start() {
    echo "Starting htpasswd-init: ensuring $HTPASSWD_FILE exists..."

    # If file already exists, don't overwrite (preserve user-changed passwords)
    if [ -f "$HTPASSWD_FILE" ]; then
        echo "  $HTPASSWD_FILE already present; leaving as is."
        return 0
    fi

    mkdir -p "$HTPASSWD_DIR" || {
        echo "  ERROR: cannot create $HTPASSWD_DIR" >&2
        return 1
    }

    # Create a temporary file, then move into place atomically
    tmpfile="$(mktemp "${HTPASSWD_FILE}.XXXXXX")" || {
        echo "  ERROR: mktemp failed" >&2
        return 1
    }

    # Generate lines
    line1="$(gen_htpasswd_line "$USER1_NAME" "$USER1_PASS")" || {
        echo "  ERROR: Could not generate hash for $USER1_NAME." >&2
        echo "         Install 'apache2-utils' (htpasswd) or 'openssl' in your image." >&2
        rm -f "$tmpfile"
        return 1
    }
    line2="$(gen_htpasswd_line "$USER2_NAME" "$USER2_PASS")" || {
        echo "  ERROR: Could not generate hash for $USER2_NAME." >&2
        rm -f "$tmpfile"
        return 1
    }

    # Write file
    {
        printf '%s\n' "$line1"
        printf '%s\n' "$line2"
    } > "$tmpfile" || {
        echo "  ERROR: writing temporary htpasswd file failed" >&2
        rm -f "$tmpfile"
        return 1
    }

    # Secure permissions and move into place
    chmod 600 "$tmpfile"
    mv "$tmpfile" "$HTPASSWD_FILE" || {
        echo "  ERROR: cannot move file into place" >&2
        rm -f "$tmpfile"
        return 1
    }

    echo "  Created $HTPASSWD_FILE with initial credentials."
    echo "  IMPORTANT: change passwords after first login:"
    echo "    htpasswd $HTPASSWD_FILE $USER1_NAME"
    echo "    htpasswd $HTPASSWD_FILE $USER2_NAME"

    # Reload/restart lighttpd if running, so it picks up the new file
    if have_cmd systemctl; then
        systemctl try-restart "$LIGHTTPD_SERVICE" 2>/dev/null || true
    elif have_cmd service; then
        service "$LIGHTTPD_SERVICE" restart 2>/dev/null || true
    fi

    return 0
}

stop() { return 0; }
restart() { start; }

case "$1" in
  start)   start ;;
  stop)    stop ;;
  restart) restart ;;
  *)       start ;;  # run at boot without args
esac

exit $?

