#!/bin/sh
# Run image verification early in boot; optionally enforce failures.

ENFORCE="${ENFORCE_VERIFY:-1}"   # 0=warn only, 1=enforce (reboot on failure)
BIN="/usr/local/sbin/verify_boot_image.sh"

case "$1" in
  start)
    echo "[verify] Starting image verification..."
    if "$BIN"; then
      echo "[verify] OK"
    else
      rc=$?
      echo "[verify] XXXXXXXXXXXXXXX FAILED XXXXXXXXXXXXXXX (rc=$rc)"
      if [ "$ENFORCE" -eq 1 ]; then
        echo "[verify] Enforcement ON. Rebooting in 5s..."
        sleep 5
        reboot -f
      fi
    fi
    ;;
  *) ;;
esac

exit 0
